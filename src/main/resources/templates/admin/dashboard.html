<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html" lang="en"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/layout/dashboard_layout}">
<head>
    <meta charset="UTF-8">
</head>
<body>
<th:block layout:fragment="content">
    <script th:inline="javascript">
        /*<![CDATA[*/
        const ctxPath = /*[[ @{/} ]]*/ '';
        /*]]>*/

        $(document).ready(function() {
            const regDate = /^\d{4}\d{2}\d{2}$/;

            $("#firstRegister").prop("checked", true);
            $("input[name='firstRegisterPage']").prop('checked', true);
            $("#firstRegisterPage").css('display', 'block');

            // 방문날짜 유효성 검사
            $("input[name='visitDay']").bind("keyup", function(e) {
                if(!isValidDateYYYYMMDD(e.target.value)) {
                    $("#warningVisitDay").css({"display" : "block"});
                } else {
                    $("#warningVisitDay").css({"display" : "none"});
                }
            });

            // 방문인원 유효성 검사
            $("input[name='visitorsNum']").bind("keyup", function(e) {
                if(!isValidNumberInput(e.target.value)) {
                    $("#warningVisitorsNum").css({"display" : "block"});
                } else {
                    $("#warningVisitorsNum").css({"display" : "none"});
                }
            });

            // 사용금액 유효성 검사
            $("input[name='spendMoney']").bind("keyup", function(e) {
                var price = e.target.value;
                price = price.replace(/,/g, '');

                if(!isValidNumberInput(price)) {
                    $("#warningSpendMoney").css({"display" : "block"});
                } else {
                    $("#warningSpendMoney").css({"display" : "none"});
                    var formatedNum = Number(price).toLocaleString();
                    $("input[name='spendMoney']").val(formatedNum);
                }
            });

            // 위도, 경도 유효성 검사
            $("input[name='latitude']").bind("keyup", function(e) {
                if(!isValidDecimalNumberInput(e.target.value)) {
                    $("#warningLongitude").css({"display" : "block"});
                } else {
                    $("#warningLongitude").css({"display" : "none"});
                }
            });

            $("input[name='longitude']").bind("keyup", function(e) {
                if(!isValidDecimalNumberInput(e.target.value)) {
                    $("#warningLongitude").css({"display" : "block"});
                } else {
                    $("#warningLongitude").css({"display" : "none"});
                }
            });
        })

        function showPage(radio) {
            var pages = document.getElementsByClassName("add_place");
            for(var i = 0; i < pages.length; i++) {
                pages[i].style.display = "none";
            }

            var pageId = radio.value;
            var pageToShow = document.getElementById(pageId);
            pageToShow.style.display = "block";
        }

        function validateFileType() {
            var fileName = $("#fileName").val();
            var idxDot = fileName.lastIndexOf(".")+1;
            var extFile = fileName.substr(idxDot, fileName.length).toLowerCase();
            if(extFile !="jpg" && extFile !="jpeg" && extFile !="png") {
                alert("이미지 파일만 업로드 해주세요");
                $("#fileName").val('');
            }
        }

        function addFirstVisit() {
            var frm = document.frmFirstVisitRestaurant;

            var cityID = $("select[name='selectedCity']").val();
            var districtID = $("select[name='selectedDistrict']").val();
            var restaurantName = $("input[name='restaurantName']").val();
            var visitDay = $("input[name='visitDay']").val();
            var visitorsNum = $("input[name='visitorsNum']").val();
            var spendMoney = $("input[name='spendMoney']").val();
            var latitude = $("input[name='latitude']").val();
            var longitude = $("input[name='latitude']").val();
            var fileName = $("input[name='fileName']").val();


        }
        function isValidDecimalNumberInput(inputValue) {
            const regDecimalNubmer = /^\d+(\.\d+)?$/;
            return regDecimalNubmer.test(inputValue);
        }

        function isValidNumberInput(inputValue) {
            const regNumber = /^[0-9]+$/;
            return regNumber.test(inputValue);
        }

        function isValidDateYYYYMMDD(dateString) {
            const regDate = /^\d{4}\d{2}\d{2}$/;
            if(!regDate.test(dateString)) {
                return false;
            }

            const year = parseInt(dateString.substr(0,4));
            const month = parseInt(dateString.substr(4,2));
            const day = parseInt(dateString.substr(6,2));

            if(month < 1 || month > 12) {
                return false;
            }

            const lastDayOfMont = new Date(year, month, 0).getDate();
            if(day < 1 || day > lastDayOfMont) {
                return false;
            }

            return true;
        }

        function getDistrictsByCity(selectElement) {
            var selectElementVal = selectElement.value;
            if(selectElementVal == "none") {
                $(select[name='selectedDistrict'].val(""));
            } else {
                var city = {"cityId": selectElementVal};
                $.ajax({
                    url: ctxPath+"admin/getDistricts",
                    processData: false,
                    contentType: "application/json",
                    type: "POST",
                    async:true,
                    data: JSON.stringify(city),
                    dataType: "json",
                    success : function(data) {
                        $("select[name='selectedDistrict']").children('option:not(:first)').remove();
                        $.each(data, function(index, item) {
                           $("select[name='selectedDistrict']").append('<option value="' + item.district_id +'">' + item.district_name + '</option');
                        });
                    },
                    error: function(request, status, error){
                        alert("code: "+request.status+"\n"+"message: "+request.responseText+"\n"+"error: "+error);
                    }
                });
            }

        }

    </script>
    <section class="sidenav-content">
        <div class="input-place-content">
            <div class="content-title">음식점 등록</div>
            <div class="list-radio">
                <input type="radio" id="firstRegister" name="selectOpt" value="firstRegisterPage" onclick="showPage(this)">
                <label for="firstRegister">처음 등록</label>
                <input type="radio" id="addVisit" name="selectOpt" value="addVisitPage" onclick="showPage(this)">
                <label for="addVisit">방문 기록만 추가</label>
            </div>

            <div class="add_place" id="firstRegisterPage">
                <form name="frmFirstVisitRestaurant">
                    <div class="add-form-wrapper">
                        <table class="add-place-table">
                            <tr>
                                <th>지역 설정</th>
                                <td>
                                    <select class="custom-select-addr" name="selectedCity" onchange="getDistrictsByCity(this)">
                                        <option value="none">광역시/도</option>
                                        <option th:each="city : ${cities}" th:value="${city.getCity_id}" th:text="${city.getCity_name}"></option>

                                    </select>

                                    <select class="custom-select-addr" name="selectedDistrict">
                                        <option value="none">시/군/구</option>
                                    </select>
                                </td>
                            </tr>

                            <tr>
                                <th>음식점명</th>
                                <td>
                                    <input class="input-place-info" name="restaurantName" type="text">
                                </td>
                            </tr>

                            <tr>
                                <th>방문일시</th>
                                <td>
                                    <input class="input-place-info" name="visitDay" type="text" placeholder="YYYYMMDD">
                                    <p class="waring-input" id="warningVisitDay">* 정확한 날짜를 입력해주세요</p>
                                </td>
                            </tr>

                            <tr>
                                <th>방문 인원</th>
                                <td>
                                    <input class="input-place-info" name="visitorsNum" type="text" placeholder="숫자만 입력해주세요">
                                    <p class="waring-input" id="warningVisitorsNum">* 숫자만 입력해주세요</p>
                                </td>
                            </tr>

                            <tr>
                                <th>사용금액</th>
                                <td>
                                    <input class="input-place-info" name="spendMoney" type="text" placeholder="숫자만 입력해주세요">
                                    <p class="waring-input" id="warningSpendMoney">* 숫자만 입력해주세요</p>
                                </td>
                            </tr>

                            <tr>
                                <th>위도/경도</th>
                                <td>
                                    <input class="input-place-info" name="latitude" type="text" placeholder="위도">
                                    <input class="input-place-info" name="longitude" type="text" placeholder="경도">
                                    <p class="waring-input" id="warningLongitude">* 위도 경도 모두 숫자를 입력해주세요</p>
                                </td>
                            </tr>

                            <tr>
                                <th>음식점 사진</th>
                                <td>
                                    <input type="file" id="fileName" name="fileName" accept="image/*" onchange="validateFileType()"/>
                                </td>
                            </tr>
                        </table>
                    </div>
                    <div class="btn-right">
                        <button type="button" class="btn-add-place" onclick="addFirstVisit()">등록하기</button>
                    </div>
                </form>
            </div>

            <div class="add_place" id="addVisitPage">
                <form>
                    <div>음식점명</div>
                    <input type="text">
                </form>
            </div>
        </div>
    </section>
</th:block>
</body>
</html>